<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#13181f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HFP Planos">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>HFP ¬∑ Planos de Trabalho</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0b0f14; --bg2:#13181f; --bg3:#1c222b; --bg4:#232a35;
    --border:#2a3140; --text:#dde4ef; --text2:#7e8fa8; --text3:#4e5d72;
    --accent:#3b82f6; --green:#22c55e; --orange:#f59e0b; --purple:#a78bfa; --red:#ef4444;
    --manha:#fb923c; --tarde:#34d399; --noite:#818cf8;
    --uldm:#3b82f6; --uc:#22c55e; --umdr:#a78bfa;
    --r:10px;
    --nav-h:58px;
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-t: env(safe-area-inset-top, 0px);
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  html{height:100%;scroll-behavior:smooth;}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100%;overflow-x:hidden;}

  /* ‚îÄ‚îÄ INSTALL BANNER ‚îÄ‚îÄ */
  .install-banner{
    background:linear-gradient(135deg,rgba(59,130,246,.15),rgba(59,130,246,.05));
    border:1px solid rgba(59,130,246,.25); border-radius:12px;
    padding:12px 14px; margin-bottom:14px;
    display:none; align-items:center; gap:12px; animation:fadeUp .4s ease;
  }
  .install-banner.show{display:flex;}
  .install-banner p{font-size:13px;flex:1;}
  .install-banner p strong{display:block;font-size:14px;margin-bottom:2px;}
  .install-banner p span{color:var(--text2);font-size:12px;}

  /* ‚îÄ‚îÄ OFFLINE INDICATOR ‚îÄ‚îÄ */
  .offline-bar{background:var(--orange);color:#000;text-align:center;font-size:12px;font-weight:600;padding:4px;display:none;}
  .offline-bar.show{display:block;}

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(ellipse 80% 60% at 30% 40%,#0f1e38,#0b0f14);padding-top:calc(20px + var(--safe-t));}
  .login-card{width:100%;max-width:420px;background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:28px 24px;animation:fadeUp .5s ease;}
  .login-brand{display:flex;align-items:center;gap:12px;margin-bottom:24px;}
  .login-brand .logo{width:44px;height:44px;background:var(--accent);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
  .login-brand h1{font-size:16px;font-weight:700;line-height:1.2;}
  .login-brand p{font-size:11px;color:var(--text2);}
  .login-card h2{font-size:20px;font-weight:600;margin-bottom:4px;}
  .login-card>p{color:var(--text2);font-size:13px;margin-bottom:22px;}

  .fg{margin-bottom:12px;}
  .fg label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;}
  .fg input,.fg select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);color:var(--text);padding:12px 14px;font-size:16px;font-family:inherit;outline:none;transition:border-color .2s;-webkit-appearance:none;appearance:none;}
  .fg input:focus,.fg select:focus{border-color:var(--accent);}
  .fg select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237e8fa8' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;}

  .svc-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
  .svc-card{border:2px solid var(--border);border-radius:var(--r);padding:12px 6px;text-align:center;cursor:pointer;transition:all .18s;background:var(--bg3);user-select:none;}
  .svc-card:active{transform:scale(.94);}
  .svc-card[data-svc="ULDM"]{--sc:var(--uldm);}
  .svc-card[data-svc="UC"]{--sc:var(--uc);}
  .svc-URG{background:rgba(239,68,68,.2);color:var(--red);border:1px solid rgba(239,68,68,.35);}
  .svc-card[data-svc="URG"]{--sc:var(--red);}

  .svc-card.active{border-color:var(--sc);background:color-mix(in srgb,var(--sc) 14%,transparent);}
  .svc-card.active .svc-name{color:var(--sc);}
  .svc-card .svc-icon{font-size:20px;margin-bottom:4px;}
  .svc-card .svc-name{font-size:13px;font-weight:700;}
  .svc-card .svc-desc{font-size:10px;color:var(--text2);margin-top:1px;}

  .coord-grid{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
  .coord-card{border:1px solid var(--border);border-radius:var(--r);padding:11px 14px;cursor:pointer;transition:all .18s;background:var(--bg3);display:flex;align-items:center;gap:12px;}
  .coord-card:active{transform:scale(.97);}
  .coord-card.active{border-color:var(--accent);background:rgba(59,130,246,.08);}
  .coord-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
  .coord-info strong{font-size:14px;font-weight:600;}
  .coord-info span{font-size:11px;color:var(--text2);display:block;margin-top:1px;}

  .pass-wrap{position:relative;}
  .pass-wrap input{padding-right:48px;}
  .pass-eye{position:absolute;right:14px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:20px;color:var(--text3);user-select:none;line-height:1;}

  .btn{padding:13px 20px;border:none;border-radius:var(--r);font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:opacity .18s,transform .1s;display:inline-flex;align-items:center;justify-content:center;gap:6px;touch-action:manipulation;-webkit-appearance:none;}
  .btn:active{transform:scale(.96);}
  .btn-block{width:100%;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-success{background:var(--green);color:#fff;}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text2);}
  .btn-ghost:active{background:rgba(255,255,255,.04);}
  .btn-purple{background:var(--purple);color:#fff;}
  .btn-sm{padding:8px 14px;font-size:13px;border-radius:8px;}

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app{display:none;min-height:100vh;padding-top:var(--safe-t);}

  /* TOPBAR */
  .topbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;height:54px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:100;}
  .tb-brand{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px;flex-shrink:0;}
  .tb-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
  .tb-svc-pill{font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;flex-shrink:0;}
  .svc-ULDM{background:rgba(59,130,246,.2);color:var(--uldm);border:1px solid rgba(59,130,246,.35);}
  .svc-UC{background:rgba(34,197,94,.2);color:var(--uc);border:1px solid rgba(34,197,94,.35);}
  .svc-UMDR{background:rgba(167,139,250,.2);color:var(--umdr);border:1px solid rgba(167,139,250,.35);}
  .notif-wrap{position:relative;cursor:pointer;font-size:20px;color:var(--text2);line-height:1;padding:4px;}
  .ndot{position:absolute;top:2px;right:1px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--bg2);}
  .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;}

  /* Topbar svc icons */
  .tb-svc-pills{display:flex;}
  .tb-svc-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;cursor:pointer;border:1px solid var(--border);background:var(--bg3);transition:all .15s;flex-shrink:0;touch-action:manipulation;}
  .tb-svc-icon:hover{border-color:var(--text2);}
  .tb-svc-icon.active{border-color:var(--accent);background:rgba(59,130,246,.15);}
  .tb-svc-icon.own{box-shadow:0 0 0 2px var(--accent);}
  .tb-svc-icon.locked{opacity:.45;cursor:default;}
  .tb-svc-icon.locked:hover{border-color:var(--border);}

  /* Bottom nav */
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--bg2);border-top:1px solid var(--border);display:flex;align-items:stretch;padding-bottom:var(--safe-b);}
  .bn-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px 4px;cursor:pointer;transition:all .15s;font-size:10px;font-weight:600;color:var(--text3);gap:3px;touch-action:manipulation;}
  .bn-tab .bn-icon{font-size:20px;line-height:1;}
  .bn-tab.active{color:var(--accent);}
  .bn-tab[data-tab="UC"].active{color:var(--uc);}
  .bn-tab[data-tab="UMDR"].active{color:var(--umdr);}
  .bn-tab:active{background:rgba(255,255,255,.04);}

  /* MAIN */
  .main{max-width:1400px;margin:0 auto;padding:14px 12px 80px;}

  /* My shifts */
  .my-banner{background:linear-gradient(120deg,rgba(59,130,246,.1),rgba(59,130,246,.04));border:1px solid rgba(59,130,246,.2);border-radius:12px;padding:14px;margin-bottom:14px;}
  .my-banner h3{font-size:13px;font-weight:600;margin-bottom:10px;}
  .my-shifts{display:flex;flex-wrap:wrap;gap:6px;}
  .msp{border-radius:8px;padding:8px 12px;border:1px solid;font-size:12px;display:flex;flex-direction:column;gap:2px;}
  .msp.manha{background:rgba(251,146,60,.1);border-color:rgba(251,146,60,.3);}
  .msp.tarde{background:rgba(52,211,153,.1);border-color:rgba(52,211,153,.3);}
  .msp.noite{background:rgba(129,140,248,.1);border-color:rgba(129,140,248,.3);}
  .msp strong{font-weight:600;font-size:13px;}
  .msp span{color:var(--text2);font-size:11px;}

  /* Stats */
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
  .stat{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:12px;display:flex;flex-direction:column;gap:3px;}
  .stat-ico{font-size:16px;}
  .stat-lbl{font-size:10px;color:var(--text3);}
  .stat-val{font-size:18px;font-weight:700;font-family:'DM Mono',monospace;}

  /* Week nav */
  .week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;}
  .wn-left{display:flex;align-items:center;gap:8px;flex:1;min-width:0;}
  .wn-left h2{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .nav-btn{width:34px;height:34px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text2);flex-shrink:0;touch-action:manipulation;}
  .wn-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
  .badge-pub{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.3);}
  .badge-draft{background:rgba(245,158,11,.12);color:var(--orange);border:1px solid rgba(245,158,11,.3);}

  /* Schedule */
  .sched-wrap{border-radius:12px;overflow:hidden;border:1px solid var(--border);background:var(--bg2);}
  .day-section{border-bottom:2px solid var(--border);}
  .day-section:last-child{border-bottom:none;}
  .day-header-row{background:var(--bg3);padding:8px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
  .dh-date{font-size:22px;font-weight:700;font-family:'DM Mono',monospace;color:var(--text);line-height:1;}
  .dh-month{font-size:11px;color:var(--text3);text-transform:uppercase;}
  .dh-week{font-size:12px;font-weight:600;color:var(--text2);}
  .today .day-header-row{background:rgba(59,130,246,.07);}
  .today .dh-date{color:var(--accent);}

  .shift-block{border-bottom:1px solid rgba(42,49,64,.5);}
  .shift-block:last-child{border-bottom:none;}
  .shift-sub-header{display:flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(255,255,255,.015);border-bottom:1px solid rgba(42,49,64,.4);}
  .sh-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
  .sh-dot.manha{background:var(--manha);}
  .sh-dot.tarde{background:var(--tarde);}
  .sh-dot.noite{background:var(--noite);}
  .sh-lbl{font-size:12px;font-weight:700;}
  .manha .sh-lbl{color:var(--manha);}
  .tarde .sh-lbl{color:var(--tarde);}
  .noite .sh-lbl{color:var(--noite);}
  .sh-time{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-left:auto;}

  .nurses-grid{display:grid;grid-template-columns:repeat(3,1fr);}
  .nurses-grid.n5{grid-template-columns:repeat(5,1fr);}
  @media(max-width:480px){
    .nurses-grid.n5{grid-template-columns:repeat(3,1fr);}
  }

  .nurse-cell{padding:7px 8px;border-right:1px solid rgba(42,49,64,.5);border-bottom:1px solid rgba(42,49,64,.3);}
  .nurse-cell:last-child{border-right:none;}
  .nurses-grid .nurse-cell:nth-child(n+4){border-bottom:none;}
  .nurses-grid.n5 .nurse-cell:nth-child(n+4){border-bottom:1px solid rgba(42,49,64,.3);}
  .nurses-grid.n5 .nurse-cell:nth-child(n+6){border-bottom:none;}

  .nc-pos{font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.03em;margin-bottom:2px;}
  .nc-name{font-size:12px;font-weight:500;color:var(--text);line-height:1.2;word-break:break-word;}
  .nc-name.hl{color:var(--accent);font-weight:700;}
  .nc-name.hl::before{content:'‚òÖ ';font-size:9px;color:var(--orange);}
  .nc-empty{font-size:11px;color:var(--text3);font-style:italic;}
  .nc-rooms{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;background:rgba(255,255,255,.04);border-radius:3px;padding:1px 5px;width:fit-content;margin-top:2px;}
  .obs-row{padding:5px 10px;font-size:11px;color:var(--orange);background:rgba(245,158,11,.04);display:flex;align-items:center;gap:5px;border-top:1px solid rgba(42,49,64,.4);}

  /* Coord panel */
  .coord-panel{display:none;}
  .section-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:14px;}
  .section-head{padding:14px;border-bottom:1px solid var(--border);}
  .section-head h3{font-size:14px;font-weight:600;display:flex;align-items:center;gap:7px;margin-bottom:3px;}
  .section-head p{font-size:12px;color:var(--text2);}
  .section-body{padding:14px;}

  /* Editor */
  .editor-section{display:none;}
  .ed-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
  .ed-hdr h3{font-size:14px;font-weight:600;}
  .ed-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .ed-day{border-bottom:1px solid var(--border);}
  .ed-day:last-child{border-bottom:none;}
  .ed-day-hdr{padding:12px 14px;background:var(--bg3);display:flex;align-items:center;justify-content:space-between;cursor:pointer;touch-action:manipulation;}
  .ed-day-hdr h4{font-size:13px;font-weight:600;}
  .chev{color:var(--text3);transition:transform .2s;}
  .ed-day-hdr.open .chev{transform:rotate(180deg);}
  .ed-day-body{display:none;padding:14px;}
  .ed-day-body.open{display:block;}
  .ed-shift{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(42,49,64,.5);}
  .ed-shift:last-of-type{border-bottom:none;margin-bottom:0;padding-bottom:0;}
  .ed-shift-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
  .pos-group{margin-bottom:10px;}
  .pos-group-lbl{font-size:10px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;}
  .pos-inputs{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
  .pos-inputs.g3{grid-template-columns:1fr 1fr 1fr;}
  .ef label{display:block;font-size:10px;color:var(--text3);margin-bottom:3px;font-weight:600;}
  .ef input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:9px 10px;font-size:14px;font-family:inherit;outline:none;transition:border-color .2s;}
  .ef input:focus{border-color:var(--accent);}

  /* Save bar */
  .save-bar{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 8px);left:12px;right:12px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:11px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,.7);z-index:200;animation:slideUp .3s ease;}
  .save-bar p{font-size:13px;flex:1;}
  .save-bar em{color:var(--orange);font-style:normal;font-weight:600;}

  /* Notif panel */
  .notif-panel{position:fixed;top:calc(54px + var(--safe-t));right:8px;left:8px;max-width:360px;margin:0 auto;background:var(--bg2);border:1px solid var(--border);border-radius:14px;box-shadow:0 16px 50px rgba(0,0,0,.7);z-index:300;display:none;}
  .notif-panel.open{display:block;animation:fadeUp .2s ease;}
  .np-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .np-hdr h4{font-size:13px;font-weight:600;}
  .np-hdr span{font-size:12px;color:var(--text3);cursor:pointer;}
  .ni{padding:11px 14px;border-bottom:1px solid rgba(42,49,64,.5);display:flex;gap:10px;cursor:pointer;}
  .ni:last-child{border-bottom:none;}
  .ni.unread{background:rgba(59,130,246,.05);}
  .ni-ico{font-size:18px;flex-shrink:0;}
  .ni-body strong{font-size:13px;}
  .ni-body p{font-size:12px;color:var(--text2);margin-top:1px;}
  .ni-body time{font-size:11px;color:var(--text3);}

  /* Storage indicator */
  .storage-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border-radius:8px;margin-bottom:12px;font-size:12px;}
  .storage-bar .s-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;}
  .storage-bar .s-dot.warn{background:var(--orange);}

  /* Category toggle */
  .cat-toggle{display:flex;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:4px;gap:4px;margin-bottom:14px;}
  .cat-btn{flex:1;padding:9px 12px;border:none;border-radius:7px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;background:transparent;color:var(--text3);touch-action:manipulation;}
  .cat-btn:active{transform:scale(.97);}
  .cat-btn.active-enf{background:var(--accent);color:#fff;}
  .cat-btn.active-aux{background:var(--orange);color:#fff;}
  .cat-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;}
  .cat-pill-enf{background:rgba(59,130,246,.18);color:var(--accent);border:1px solid rgba(59,130,246,.3);}
  .cat-pill-aux{background:rgba(251,146,60,.18);color:var(--orange);border:1px solid rgba(251,146,60,.3);}

  .sep{height:1px;background:var(--border);margin:18px 0;}

  @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}

  @media(min-width:768px){
    .stats{grid-template-columns:repeat(4,1fr);}
    .nurses-grid.n5{grid-template-columns:repeat(5,1fr);}
    .pos-inputs{grid-template-columns:1fr 1fr 1fr;}
    .pos-inputs.g3{grid-template-columns:1fr 1fr 1fr;}
  }
  @media(max-width:767px){
    .stats{grid-template-columns:repeat(2,1fr);}
  }
</style>
</head>
<body>

<div class="offline-bar" id="offline-bar">‚ö†Ô∏è Sem liga√ß√£o √† internet ‚Äî a trabalhar offline</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <!-- Install banner -->
    <div class="install-banner" id="install-banner">
      <span style="font-size:28px">üì≤</span>
      <p><strong>Instalar como app</strong><span>Toque para instalar no ecr√£ inicial</span></p>
      <button class="btn btn-primary btn-sm" onclick="installApp()">Instalar</button>
    </div>

    <div class="login-brand">
      <div class="logo">üè•</div>
      <div><h1>Hospital Fernando Pessoa</h1><p>Planos de Trabalho</p></div>
    </div>
    <h2>Bem-vindo(a)</h2>
    <p>Selecione o servi√ßo e o seu perfil</p>

    <div class="fg">
      <label>Servi√ßo</label>
      <div class="svc-grid" style="grid-template-columns:repeat(2,1fr)">
        <div class="svc-card" data-svc="ULDM" onclick="selectSvc('ULDM')"><div class="svc-icon">üõèÔ∏è</div><div class="svc-name">ULDM</div><div class="svc-desc">Longa Dura√ß√£o</div></div>
        <div class="svc-card" data-svc="UC"   onclick="selectSvc('UC')"><div class="svc-icon">üíä</div><div class="svc-name">UC</div><div class="svc-desc">Convalescen√ßa</div></div>
        <div class="svc-card" data-svc="UMDR" onclick="selectSvc('UMDR')"><div class="svc-icon">ü©∫</div><div class="svc-name">UMDR</div><div class="svc-desc">M√©dia Dura√ß√£o</div></div>
        <div class="svc-card" data-svc="URG"  onclick="selectSvc('URG')"><div class="svc-icon">üö®</div><div class="svc-name">URG</div><div class="svc-desc">Urg√™ncia</div></div>
      </div>
    </div>

    <div class="fg">
      <label>Perfil</label>
      <select id="login-role" onchange="onRoleChange()">
        <option value="nurse">Enfermeiro(a)</option>
        <option value="auxiliar">Auxiliar de Sa√∫de</option>
        <option value="coordinator">Enfermeiro(a) Coordenador(a)</option>
      </select>
    </div>

    <div id="coord-grp" style="display:none">
      <div class="fg">
        <label>Coordenador(a)</label>
        <div class="coord-grid">
          <div class="coord-card" data-coord="Renata Gondar" onclick="selectCoord('Renata Gondar')">
            <div class="coord-av" style="background:var(--accent)">RG</div>
            <div class="coord-info"><strong>Renata Gondar</strong><span>Enf.¬™ Coordenadora</span></div>
          </div>
          <div class="coord-card" data-coord="Marta Cardoso" onclick="selectCoord('Marta Cardoso')">
            <div class="coord-av" style="background:var(--purple)">MC</div>
            <div class="coord-info"><strong>Marta Cardoso</strong><span>Enf.¬™ Coordenadora</span></div>
          </div>
          <div class="coord-card" data-coord="Nuno Abreu" onclick="selectCoord('Nuno Abreu')">
            <div class="coord-av" style="background:var(--green)">NA</div>
            <div class="coord-info"><strong>Nuno Abreu</strong><span>Enf.¬∫ Coordenador</span></div>
          </div>
          <div class="coord-card" data-coord="Adriano Coutinho" onclick="selectCoord('Adriano Coutinho')">
            <div class="coord-av" style="background:var(--red)">AC</div>
            <div class="coord-info"><strong>Adriano Coutinho</strong><span>Enf.¬∫ Coordenador</span></div>
          </div>
        </div>
      </div>
      <div class="fg">
        <label>C√≥digo de acesso</label>
        <div class="pass-wrap">
          <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" inputmode="text">
          <span class="pass-eye" onclick="togglePass()">üëÅ</span>
        </div>
      </div>
    </div>

    <button class="btn btn-primary btn-block" onclick="doLogin()" style="margin-top:10px">Entrar ‚Üí</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="tb-brand">üè• <span>HFP</span></div>
    <div class="tb-right">
      <div class="tb-svc-pills" id="tb-svc-pills" style="display:none;gap:4px;align-items:center">
        <div class="tb-svc-icon" data-svc="ULDM" onclick="switchSvc('ULDM')" title="ULDM">üõè</div>
        <div class="tb-svc-icon" data-svc="UC"   onclick="switchSvc('UC')"   title="UC">üíä</div>
        <div class="tb-svc-icon" data-svc="UMDR" onclick="switchSvc('UMDR')" title="UMDR">ü©∫</div>
        <div class="tb-svc-icon" data-svc="URG"  onclick="switchSvc('URG')"  title="URG">üö®</div>
      </div>
      <div class="tb-svc-pill" id="tb-svc-pill">‚Äî</div>
      <div class="notif-wrap" onclick="toggleNotif()">üîî<div class="ndot" id="ndot" style="display:none"></div></div>
      <div class="avatar" id="tb-avatar" onclick="doLogout()" title="Sair">?</div>
    </div>
  </div>

  <div class="notif-panel" id="notif-panel">
    <div class="np-hdr"><h4>üîî Notifica√ß√µes</h4><span onclick="markAllRead()">Marcar lidas</span></div>
    <div id="notif-list"></div>
  </div>

  <div class="main">

    <!-- Storage indicator (coord only) -->
    <div class="storage-bar" id="storage-bar" style="display:none">
      <div class="s-dot" id="s-dot"></div>
      <span id="s-msg">Dados guardados localmente</span>
      <button class="btn btn-ghost btn-sm" style="margin-left:auto;padding:4px 10px;font-size:11px" onclick="exportData()">üì§ Exportar</button>
    </div>

    <div class="my-banner" id="my-banner" style="display:none">
      <h3>‚≠ê Os meus turnos ¬∑ <span id="my-svc-lbl" style="opacity:.6;font-weight:400"></span> <span id="my-cat-lbl" style="opacity:.6;font-weight:400"></span></h3>
      <div class="my-shifts" id="my-shifts"></div>
    </div>

    <div class="stats" id="stats" style="display:none">
      <div class="stat"><div class="stat-ico">üë©‚Äç‚öïÔ∏è</div><div class="stat-lbl">Enfermeiros</div><div class="stat-val" id="s-nurses">‚Äî</div></div>
      <div class="stat"><div class="stat-ico">üåÖ</div><div class="stat-lbl">Manh√£</div><div class="stat-val">5</div></div>
      <div class="stat"><div class="stat-ico">üåÜ</div><div class="stat-lbl">Tarde</div><div class="stat-val">5</div></div>
      <div class="stat"><div class="stat-ico">üåô</div><div class="stat-lbl">Noite</div><div class="stat-val">3</div></div>
    </div>

    <!-- Category toggle (dynamic) -->
    <div class="cat-toggle" id="cat-toggle" style="display:none"></div>

    <!-- Readonly banner for coordinator viewing other service -->
    <div id="readonly-banner" style="display:none;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:var(--orange)">
      üëÅ Modo de visualiza√ß√£o ‚Äî s√≥ pode editar o plano do seu servi√ßo
    </div>

    <div class="week-nav">
      <div class="wn-left">
        <div class="nav-btn" onclick="prevWeek()">‚Äπ</div>
        <h2 id="week-title">‚Äî</h2>
        <div class="nav-btn" onclick="nextWeek()">‚Ä∫</div>
      </div>
      <div class="wn-right">
        <button class="btn btn-ghost btn-sm" onclick="goToday()">Hoje</button>
        <span id="pub-badge"></span>
      </div>
    </div>

    <div class="sched-wrap"><div id="sched-body"></div></div>

    <!-- Coordinator panel -->
    <div class="coord-panel" id="coord-panel">
      <div class="sep"></div>

      <div class="editor-section" id="editor-section">
        <div class="ed-hdr">
          <h3>‚úèÔ∏è Editar Plano</h3>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm" onclick="downloadPDF()">üìÑ PDF</button>
            <button class="btn btn-ghost btn-sm" onclick="publishPlan()">üì¢ Publicar</button>
            <button class="btn btn-success btn-sm" onclick="savePlan()">üíæ Guardar</button>
          </div>
        </div>
        <div class="ed-card" id="ed-body"></div>
      </div>
    </div>

  </div><!-- /main -->

  <div class="bottom-nav" id="bottom-nav" style="display:none">
    <div class="bn-tab" data-tab="ULDM" onclick="switchSvc('ULDM')"><span class="bn-icon">üõè</span>ULDM</div>
    <div class="bn-tab" data-tab="UC"   onclick="switchSvc('UC')"><span class="bn-icon">üíä</span>UC</div>
    <div class="bn-tab" data-tab="UMDR" onclick="switchSvc('UMDR')"><span class="bn-icon">ü©∫</span>UMDR</div>
  </div>

  <div class="save-bar" id="save-bar" style="display:none">
    <p>‚ö†Ô∏è <em id="unsaved-n">0</em> altera√ß√µes n√£o guardadas</p>
    <button class="btn btn-success btn-sm" onclick="savePlan()">Guardar</button>
    <button class="btn btn-ghost btn-sm" onclick="discardChanges()">‚úï</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA ‚Äî Service Worker registration
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Service Worker para PWA (funciona quando publicado no Netlify)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registado:', reg.scope))
      .catch(err => console.log('SW erro:', err));
  });
}

// PWA install prompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('install-banner').classList.add('show');
});
window.addEventListener('appinstalled', () => {
  document.getElementById('install-banner').classList.remove('show');
  deferredPrompt = null;
  showToast('‚úÖ App instalada com sucesso!');
});
async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') document.getElementById('install-banner').classList.remove('show');
  deferredPrompt = null;
}

// Offline detection
function updateOnline() {
  document.getElementById('offline-bar').classList.toggle('show', !navigator.onLine);
}
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);
updateOnline();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE ‚Äî JSONBin cloud + localStorage cache
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const JSONBIN_KEY = '$2a$10$WSwa2GSR2kjrgHPSZ0alteVav5m/MWjnizdGQUvTlsEiDLM6Jiduy';
const JSONBIN_BIN = '69984226ae596e708f39d0b3';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN}`;
const CACHE_KEY   = 'hfp_planos_cache';

function cacheLocal(data) {
  try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } catch(e) {}
}
function loadCache() {
  try { const r = localStorage.getItem(CACHE_KEY); return r ? JSON.parse(r) : null; } catch(e) { return null; }
}

async function saveToStorage() {
  const data = {
    schedule: state.schedule,
    notifications: state.notifications,
    savedAt: new Date().toISOString()
  };
  cacheLocal(data);
  updateStorageBar('saving');
  try {
    const body = JSON.stringify(data);
    const resp = await fetch(JSONBIN_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
      body: body
    });
    if (!resp.ok) {
      const errText = await resp.text();
      console.warn('JSONBin error:', resp.status, errText);
      throw new Error('HTTP ' + resp.status + ': ' + errText);
    }
    updateStorageBar(true);
  } catch(e) {
    console.warn('JSONBin save error:', e);
    updateStorageBar(false);
    showToast('‚ö†Ô∏è Erro ao guardar na cloud: ' + e.message);
  }
}

async function loadFromCloud() {
  try {
    const resp = await fetch(JSONBIN_URL + '/latest');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const json = await resp.json();
    return json.record || null;
  } catch(e) {
    console.warn('JSONBin load error:', e);
    return null;
  }
}

function updateStorageBar(state) {
  const dot = document.getElementById('s-dot');
  const msg = document.getElementById('s-msg');
  if (!dot || !msg) return;
  if (state === 'saving') {
    dot.className = 's-dot';dot.style.background='var(--orange)';
    msg.textContent = 'A guardar na cloud‚Ä¶';
  } else if (state === true) {
    dot.className = 's-dot';dot.style.background='';
    const d = new Date();
    msg.textContent = `‚òÅÔ∏è Guardado ‚Äî ${d.toLocaleTimeString('pt-PT', {hour:'2-digit',minute:'2-digit'})}`;
  } else {
    dot.className = 's-dot warn';
    msg.textContent = '‚ö†Ô∏è Erro ao guardar ‚Äî cache local guardada';
  }
}

function exportData() {
  const data = { schedule: state.schedule, exportedAt: new Date().toISOString(), version: 'hfp-v2' };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `hfp-planos-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('üì§ Dados exportados com sucesso!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COORDINATORS = {
  'Renata Gondar':    { pass:'renata', svc:'UC',   color:'var(--accent)', initials:'RG' },
  'Marta Cardoso':    { pass:'marta',  svc:'UMDR', color:'var(--purple)', initials:'MC' },
  'Nuno Abreu':       { pass:'nuno',   svc:'ULDM', color:'var(--green)',  initials:'NA' },
  'Adriano Coutinho': { pass:'adriano',svc:'URG',  color:'var(--red)',    initials:'AC' },
};

const SERVICES = {
  ULDM:{
    name:'ULDM', label:'Unidade de Longa Dura√ß√£o e Manuten√ß√£o',
    roomsHint:{
      manha:['401‚Äì403','404‚Äì405','406‚Äì408','409‚Äì410','411‚Äì415'],
      tarde: ['401‚Äì403','404‚Äì405','406‚Äì408','409‚Äì410','411‚Äì415'],
      noite: ['401‚Äì414','415‚Äì426','427‚Äì437']
    },
    nurses:['Catarina','Rita','S√©rgio','Sara','Patr√≠cia P.','Tatiana R.','Beatriz B.','Diana C.','NeoKen','Helena','Filipe','Suna','Vasco','Andressa','In√™s Moreira','Beatriz D.','Tm√™s R.','Tatiana P.','Neuza'],
    sample:{
      manha:[{name:'Catarina',rooms:'401‚Äì403'},{name:'NeoKen',rooms:'404‚Äì405'},{name:'Sara',rooms:'406‚Äì408'},{name:'S√©rgio',rooms:'409‚Äì410'},{name:'Tatiana R.',rooms:'411‚Äì415'}],
      tarde: [{name:'Patr√≠cia P.',rooms:'401‚Äì403'},{name:'Rita',rooms:'404‚Äì405'},{name:'Helena',rooms:'406‚Äì408'},{name:'Vasco',rooms:'409‚Äì410'},{name:'Andressa',rooms:'411‚Äì415'}],
      noite: [{name:'Beatriz B.',rooms:'401‚Äì414'},{name:'Beatriz D.',rooms:'415‚Äì426'},{name:'Filipe',rooms:'427‚Äì437'}],
    },
    auxiliares:['Ana Lopes','Carlos Matos','F√°tima Silva','Jo√£o Ferreira','Maria Costa','Pedro Santos','Rosa Oliveira','Tiago Pinto'],
    auxRoomsHint:{
      manha:['401‚Äì408','409‚Äì415','‚Äî','‚Äî','‚Äî'],
      tarde: ['401‚Äì408','409‚Äì415','‚Äî','‚Äî','‚Äî'],
      noite: ['401‚Äì415','416‚Äì437','‚Äî']
    },
    auxSample:{
      manha:[{name:'Ana Lopes',rooms:'401‚Äì408'},{name:'Carlos Matos',rooms:'409‚Äì415'},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      tarde: [{name:'F√°tima Silva',rooms:'401‚Äì408'},{name:'Jo√£o Ferreira',rooms:'409‚Äì415'},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      noite: [{name:'Maria Costa',rooms:'401‚Äì415'},{name:'',rooms:''},{name:'',rooms:''}],
    }
  },
  UC:{
    name:'UC', label:'Unidade de Convalescen√ßa',
    roomsHint:{
      manha:['306B‚Äì308','309‚Äì310','311‚Äì312','301‚Äì303','304‚Äì306A'],
      tarde: ['306B‚Äì308','309‚Äì310','311‚Äì312','301‚Äì303','304‚Äì306A'],
      noite: ['301‚Äì306A','306B‚Äì312','‚Äî']
    },
    nurses:['Ana S.','Helema','Daniela R.','S√≠lvia','Adriana','Diana Coelho','Beatriz C.','Rafaela','Margarida','Neuza','Beatriz R.','Afonso','Pamelo','F√°tima','Daniela P.'],
    sample:{
      manha:[{name:'Ana S.',rooms:'306B‚Äì308'},{name:'Neuza',rooms:'309‚Äì310'},{name:'Helema',rooms:'311‚Äì312'},{name:'Rafaela',rooms:'301‚Äì303'},{name:'Margarida',rooms:'304‚Äì306A'}],
      tarde: [{name:'Ana S.',rooms:'306B‚Äì308'},{name:'Beatriz C.',rooms:'309‚Äì310'},{name:'S√≠lvia',rooms:'311‚Äì312'},{name:'Afonso',rooms:'301‚Äì303'},{name:'F√°tima',rooms:'304‚Äì306A'}],
      noite: [{name:'Pamelo',rooms:'301‚Äì306A'},{name:'Daniela R.',rooms:'306B‚Äì312'},{name:'',rooms:''}],
    },
    auxiliares:['Bruno Alves','Carla Neves','Dora Ramos','Eduardo Lima','Filipa Sousa','Gra√ßa Mendes','Hugo Correia'],
    auxRoomsHint:{
      manha:['301‚Äì306A','306B‚Äì312','‚Äî','‚Äî','‚Äî'],
      tarde: ['301‚Äì306A','306B‚Äì312','‚Äî','‚Äî','‚Äî'],
      noite: ['301‚Äì312','‚Äî','‚Äî']
    },
    auxSample:{
      manha:[{name:'Bruno Alves',rooms:'301‚Äì306A'},{name:'Carla Neves',rooms:'306B‚Äì312'},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      tarde: [{name:'Dora Ramos',rooms:'301‚Äì306A'},{name:'Eduardo Lima',rooms:'306B‚Äì312'},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      noite: [{name:'Filipa Sousa',rooms:'301‚Äì312'},{name:'',rooms:''},{name:'',rooms:''}],
    }
  },
  UMDR:{
    name:'UMDR', label:'Unidade de M√©dia Dura√ß√£o e Reabilita√ß√£o',
    roomsHint:{
      manha:['333‚Äì335','336‚Äì337','338‚Äì339','318‚Äì321','328‚Äì332'],
      tarde: ['333‚Äì335','336‚Äì337','338‚Äì339','318‚Äì321','328‚Äì332'],
      noite: ['318‚Äì325','326‚Äì332','333‚Äì339']
    },
    nurses:['Ana Costa','Rafaela','Beatriz R.','Margarida','Diana C√¢n','Andreia G.','Afonso','Helena','Luciana','Rui','Amas G.','Diana Coelho','T√¢nia (CCE)','Vasco','S√©rgio','Ana Sofia','Adriana'],
    sample:{
      manha:[{name:'Ana Costa',rooms:'333‚Äì335'},{name:'Mily Ob.',rooms:'336‚Äì337'},{name:'Joana L.',rooms:'338‚Äì339'},{name:'Andreia G.',rooms:'318‚Äì321'},{name:'Rafaela',rooms:'328‚Äì332'}],
      tarde: [{name:'Ana Costa',rooms:'333‚Äì335'},{name:'Mily Ob.',rooms:'336‚Äì337'},{name:'Helena',rooms:'338‚Äì339'},{name:'Luciana',rooms:'318‚Äì321'},{name:'Rui',rooms:'328‚Äì332'}],
      noite: [{name:'Mariana',rooms:'318‚Äì325'},{name:'Diana C.',rooms:'326‚Äì332'},{name:'',rooms:''}],
    },
    auxiliares:['Alice Rodrigues','Bernardo Cruz','C√©lia Martins','Daniel Gomes','Elsa Pereira','Francisco Brito','Guida Monteiro'],
    auxRoomsHint:{
      manha:['318‚Äì326','327‚Äì332','333‚Äì339','‚Äî','‚Äî'],
      tarde: ['318‚Äì326','327‚Äì332','333‚Äì339','‚Äî','‚Äî'],
      noite: ['318‚Äì329','330‚Äì339','‚Äî']
    },
    auxSample:{
      manha:[{name:'Alice Rodrigues',rooms:'318‚Äì326'},{name:'Bernardo Cruz',rooms:'327‚Äì332'},{name:'C√©lia Martins',rooms:'333‚Äì339'},{name:'',rooms:''},{name:'',rooms:''}],
      tarde: [{name:'Daniel Gomes',rooms:'318‚Äì326'},{name:'Elsa Pereira',rooms:'327‚Äì332'},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      noite: [{name:'Francisco Brito',rooms:'318‚Äì329'},{name:'',rooms:''},{name:'',rooms:''}],
    }
  },
  URG:{
    name:'URG', label:'Urg√™ncia',
    postos:    ['Adultos','Pediatria','Consulta Ped.','SMIP'],
    auxPostos: ['Adultos','Pediatria'],
    roomsHint:{ manha:['','','',''], tarde:['','','',''], noite:['','','',''] },
    nurses:['Enf. 1','Enf. 2','Enf. 3','Enf. 4'],
    sample:{
      manha:[{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      tarde: [{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
      noite: [{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''},{name:'',rooms:''}],
    },
    auxiliares:['Aux. 1','Aux. 2'],
    auxRoomsHint:{ manha:['',''], tarde:['',''], noite:[] },
    auxSample:{
      manha:[{name:'',rooms:''},{name:'',rooms:''}],
      tarde: [{name:'',rooms:''},{name:'',rooms:''}],
      noite: [],
    },
  }
};

const SHIFTS = {
  manha:{label:'M',time:'',count:5},
  tarde: {label:'T', time:'',count:5},
  noite: {label:'N', time:'',count:3},
};
const MONTHS=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  user: null,
  activeSvc: 'ULDM',
  activeCat: 'enfermeiros',
  currentWeek: null,
  schedule: {
    ULDM:{ enfermeiros:{}, auxiliares:{} },
    UC:  { enfermeiros:{}, auxiliares:{} },
    UMDR:{ enfermeiros:{}, auxiliares:{} },
    URG: { enfermeiros:{}, auxiliares:{} }
  },
  unsaved: 0,
  parsedData: null,
  notifications: [
    {id:1,ico:'üìã',title:'Plano ULDM publicado',msg:'Plano da semana atual publicado.',time:'H√° 2h',read:false},
    {id:2,ico:'‚ö†Ô∏è',title:'Altera√ß√£o UC',msg:'Turno de Quinta-feira Manh√£ atualizado.',time:'H√° 1 dia',read:false},
    {id:3,ico:'‚úÖ',title:'Stock farm√°cia',msg:'Contagem agendada para amanh√£.',time:'H√° 2 dias',read:true},
  ]
};

// Load persisted data
function applyPersistedData(persisted) {
  if (!persisted) return;
  if (persisted.schedule) {
    Object.keys(persisted.schedule).forEach(svc => {
      if (!state.schedule[svc]) return;
      const saved = persisted.schedule[svc];
      if (saved.enfermeiros !== undefined || saved.auxiliares !== undefined) {
        if (saved.enfermeiros) state.schedule[svc].enfermeiros = saved.enfermeiros;
        if (saved.auxiliares)  state.schedule[svc].auxiliares  = saved.auxiliares;
      } else if (Object.keys(saved).length > 0) {
        state.schedule[svc].enfermeiros = saved;
      }
    });
  }
  if (persisted.notifications) state.notifications = persisted.notifications;
}

// Apply cache immediately so app feels instant, then sync cloud in background
applyPersistedData(loadCache());

async function syncFromCloud() {
  const cloud = await loadFromCloud();
  if (!cloud) return;
  cacheLocal(cloud);
  applyPersistedData(cloud);
  if (state.user) {
    // Re-ensure week without overwriting existing data, then render
    const wkey = state.currentWeek;
    if (wkey && !((state.schedule[state.activeSvc][state.activeCat]||{})[wkey])) {
      ensureWeek(state.activeSvc, wkey);
    }
    renderAll();
  }
}
syncFromCloud();

// Auto-refresh every 30s ‚Äî always fetch latest from cloud
setInterval(syncFromCloud, 30000);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') syncFromCloud(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getMonday(d){const dt=new Date(d);const day=dt.getDay();dt.setDate(dt.getDate()+(day===0?-6:1-day));dt.setHours(0,0,0,0);return dt;}
function isoDate(d){return d.toISOString().split('T')[0];}
function isToday(s){return s===isoDate(new Date());}
function todayKey(){return isoDate(getMonday(new Date()));}
function weekLabel(mon){const m=new Date(mon+'T00:00:00'),s=new Date(m);s.setDate(s.getDate()+6);return `${m.getDate()} ${MONTHS[m.getMonth()]} ‚Äì ${s.getDate()} ${MONTHS[s.getMonth()]} ${s.getFullYear()}`;}
function initials(n){return n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);}

const emptySlot=()=>({name:'',rooms:''});
function getActiveCat(){
  return state.activeCat;
}
function ensureWeek(svc,wkey){
  const cat=state.activeCat||'enfermeiros';
  if(!state.schedule[svc]) return;
  if(!state.schedule[svc][cat]) state.schedule[svc][cat]={};
  if(state.schedule[svc][cat][wkey])return;
  const wdays=['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
  const cfg=SERVICES[svc];
  // Determine slot counts per shift
  let mCount=5, tCount=5, nCount=3;
  if(svc==='URG'){
    if(cat==='enfermeiros') { mCount=4; tCount=4; nCount=4; }
    if(cat==='auxiliares')  { mCount=2; tCount=2; nCount=0; }
  }
  const sampleData = cat==='auxiliares' ? cfg.auxSample : cfg.sample;
  state.schedule[svc][cat][wkey]={
    published:false,
    days:wdays.map((wd,i)=>{
      const d=new Date(wkey+'T00:00:00');d.setDate(d.getDate()+i);
      return{
        date:isoDate(d),weekday:wd,
        manha:Array(mCount).fill(null).map(()=>emptySlot()),
        tarde:Array(tCount).fill(null).map(()=>emptySlot()),
        noite:Array(nCount).fill(null).map(()=>emptySlot()),
        obs:''
      };
    })
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedSvc='ULDM', selectedCoord=null;

function selectSvc(s){
  selectedSvc=s;
  document.querySelectorAll('.svc-card').forEach(c=>c.classList.toggle('active',c.dataset.svc===s));
}
selectSvc('ULDM');

function onRoleChange(){
  const isCoord=document.getElementById('login-role').value==='coordinator';
  document.getElementById('coord-grp').style.display=isCoord?'block':'none';
}

function selectCoord(name){
  selectedCoord=name;
  document.querySelectorAll('.coord-card').forEach(c=>c.classList.toggle('active',c.dataset.coord===name));
}

function togglePass(){
  const inp=document.getElementById('login-pass');
  inp.type=inp.type==='password'?'text':'password';
}

function doLogin(){
  if(!selectedSvc){alert('Selecione um servi√ßo.');return;}
  const role=document.getElementById('login-role').value;
  if(role==='coordinator'){
    if(!selectedCoord){alert('Selecione o coordenador.');return;}
    const coordCfg=COORDINATORS[selectedCoord];
    if(document.getElementById('login-pass').value!==coordCfg.pass){alert('C√≥digo incorreto.');return;}
    state.user={name:selectedCoord,role:'coordinator',ownSvc:coordCfg.svc};
    state.activeSvc=coordCfg.svc;
    state.activeCat='enfermeiros';
  } else if(role==='auxiliar'){
    state.user={name:'Auxiliar',role:'auxiliar'};
    state.activeCat='auxiliares';
    state.activeSvc=selectedSvc;
  } else {
    state.user={name:'Enfermeiro',role:'nurse'};
    state.activeCat='enfermeiros';
    state.activeSvc=selectedSvc;
  }
  state.currentWeek=todayKey();
  Object.keys(SERVICES).forEach(s=>ensureWeek(s,state.currentWeek));
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  setupUI();

  // Always fetch fresh data from cloud on login ‚Äî ignore local cache
  localStorage.removeItem(CACHE_KEY);
  showToast('‚è≥ A carregar planos‚Ä¶');
  loadFromCloud().then(cloud => {
    if(cloud){
      cacheLocal(cloud);
      applyPersistedData(cloud);
    }
    renderAll();
  }).catch(()=>renderAll());
}

function doLogout(){
  if(state.unsaved>0&&!confirm('Altera√ß√µes n√£o guardadas. Sair mesmo assim?'))return;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').style.display='none';
  state.user=null; state.unsaved=0; selectedCoord=null;
  document.getElementById('save-bar').style.display='none';
  document.querySelectorAll('.coord-card').forEach(c=>c.classList.remove('active'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupUI(){
  const{name,role}=state.user;
  const av=document.getElementById('tb-avatar');
  if(role==='coordinator'){
    av.textContent=initials(name);
    if(name==='Marta Cardoso') av.style.background='var(--purple)';
    else if(name==='Nuno Abreu') av.style.background='var(--green)';
    else av.style.background='var(--accent)';
  } else if(role==='auxiliar'){
    av.textContent='AS';
    av.style.background='var(--orange)';
  } else {
    av.textContent='ENF';
    av.style.background='var(--accent)';
  }

  if(role==='coordinator'){
    document.getElementById('stats').style.display='grid';
    document.getElementById('coord-panel').style.display='block';
    document.getElementById('editor-section').style.display='block';
    document.getElementById('bottom-nav').style.display='none';
    document.getElementById('storage-bar').style.display='flex';
    document.getElementById('cat-toggle').style.display='flex';
    document.getElementById('tb-svc-pills').style.display='flex';
    updateStorageBar(!!loadCache());
  }
  renderNotifs();
}

function switchSvc(s){
  if(state.user?.role!=='coordinator')return;
  state.activeSvc=s;
  ensureWeek(s,state.currentWeek);
  renderAll();
}

function switchCat(cat){
  state.activeCat=cat;
  ensureWeek(state.activeSvc,state.currentWeek);
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function prevWeek(){shiftWeek(-7);}
function nextWeek(){shiftWeek(7);}
function goToday(){state.currentWeek=todayKey();Object.keys(SERVICES).forEach(s=>ensureWeek(s,state.currentWeek));renderAll();}
function shiftWeek(d){const dt=new Date(state.currentWeek+'T00:00:00');dt.setDate(dt.getDate()+d);state.currentWeek=isoDate(dt);Object.keys(SERVICES).forEach(s=>ensureWeek(s,state.currentWeek));renderAll();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  const svc=state.activeSvc;
  const cat=state.activeCat;
  const week=(state.schedule[svc][cat]||{})[state.currentWeek]||{published:false,days:[]};
  const lbl=weekLabel(state.currentWeek);
  const cfg=SERVICES[svc];

  document.getElementById('week-title').textContent=`Semana de ${lbl}`;
  const pill=document.getElementById('tb-svc-pill');
  pill.textContent=svc; pill.className=`tb-svc-pill svc-${svc}`;
  document.querySelectorAll('.bn-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===svc));
  document.getElementById('pub-badge').innerHTML=week.published
    ?'<span class="badge badge-pub">‚úÖ Pub.</span>'
    :'<span class="badge badge-draft">‚è≥ Rascunho</span>';
  if(document.getElementById('s-nurses'))
    document.getElementById('s-nurses').textContent=cat==='auxiliares'?cfg.auxiliares.length:cfg.nurses.length;
  const edLbl=document.getElementById('ed-svc-lbl');if(edLbl)edLbl.textContent=cfg.label;
  const myLbl=document.getElementById('my-svc-lbl');if(myLbl)myLbl.textContent=svc;
  const myCatLbl=document.getElementById('my-cat-lbl');if(myCatLbl)myCatLbl.textContent=cat==='auxiliares'?'¬∑ Auxiliar':'¬∑ Enfermeiro(a)';

  // Render dynamic cat toggle
  const catToggle=document.getElementById('cat-toggle');
  if(catToggle && state.user?.role==='coordinator'){
    catToggle.innerHTML=`
      <button class="cat-btn${cat==='enfermeiros'?' active-enf':''}" onclick="switchCat('enfermeiros')">üë©‚Äç‚öïÔ∏è Enfermeiros</button>
      <button class="cat-btn${cat==='auxiliares'?' active-aux':''}" onclick="switchCat('auxiliares')">üè• Auxiliares de Sa√∫de</button>`;
  }

  // Update topbar svc icons (coordinator only)
  if(state.user?.role==='coordinator'){
    const ownSvc=state.user.ownSvc;
    const isOwn=svc===ownSvc;
    document.querySelectorAll('.tb-svc-icon').forEach(el=>{
      const s=el.dataset.svc;
      el.className='tb-svc-icon'+(s===svc?' active':'')+(s===ownSvc?' own':'');
    });
    document.getElementById('editor-section').style.display=isOwn?'block':'none';
    document.getElementById('coord-panel').style.display=isOwn?'block':'none';
    document.getElementById('cat-toggle').style.display=isOwn?'flex':'none';
    document.getElementById('readonly-banner').style.display=isOwn?'none':'flex';
  }

  renderSchedule(week);
  if(state.user?.role==='coordinator'&&svc===state.user.ownSvc) renderEditor(week);
}

function renderSchedule(week){
  const body=document.getElementById('sched-body');
  if(!week.days?.length){body.innerHTML='<div style="padding:32px;text-align:center;color:var(--text3)">Sem dados.</div>';return;}
  body.innerHTML=week.days.map(day=>renderDay(day)).join('');
}

function renderDay(day){
  const d=new Date(day.date+'T00:00:00');
  const tc=isToday(day.date)?'today':'';
  const svc=state.activeSvc;
  const cat=state.activeCat;
  const cfg=SERVICES[svc];
  const postos=svc==='URG'?(cat==='auxiliares'?cfg.auxPostos:cfg.postos):null;

  const shiftHtml=sk=>{
    const slots=day[sk]||[];
    if(!slots.length) return '';
    const posPrefix=sk==='manha'?'M':sk==='tarde'?'T':'N';
    const isN5=slots.length>=5;
    const cells=slots.map((slot,i)=>{
      const nm=slot.name||'';
      const lbl=postos?postos[i]:`${posPrefix}${i+1}`;
      return `<div class="nurse-cell">
        <div class="nc-pos" style="${postos?'font-size:8.5px;line-height:1.1':''}">${lbl}</div>
        ${nm?`<div class="nc-name">${nm}</div>`:'<div class="nc-empty">‚Äî</div>'}
        ${slot.rooms&&slot.rooms!=='‚Äî'?`<div class="nc-rooms">${slot.rooms}</div>`:''}
      </div>`;
    }).join('');
    const obs=sk==='noite'&&day.obs?`<div class="obs-row">‚ö° ${day.obs}</div>`:'';
    return `<div class="shift-block ${sk}">
      <div class="shift-sub-header">
        <div class="sh-dot ${sk}"></div>
        <span class="sh-lbl">${posPrefix}</span>
      </div>
      <div class="nurses-grid${isN5?' n5':''}">${cells}</div>
      ${obs}
    </div>`;
  };

  return `<div class="day-section ${tc}">
    <div class="day-header-row">
      <span class="dh-date">${d.getDate()}</span>
      <span class="dh-month">${MONTHS[d.getMonth()]}</span>
      <span class="dh-week">${day.weekday}</span>
      ${isToday(day.date)?'<span style="font-size:10px;color:var(--accent);background:rgba(59,130,246,.12);padding:2px 7px;border-radius:10px;margin-left:auto">Hoje</span>':''}
    </div>
    ${shiftHtml('manha')}${shiftHtml('tarde')}${shiftHtml('noite')}
  </div>`;
}

function renderMyShifts(week){
  const uname=state.user.name.toLowerCase().split(' ')[0];
  const pills=[];
  (week.days||[]).forEach(day=>{
    const d=new Date(day.date+'T00:00:00');
    ['manha','tarde','noite'].forEach(sk=>{
      const slots=day[sk]||[];
      const idx=slots.findIndex(s=>s.name&&s.name.toLowerCase().includes(uname));
      if(idx===-1)return;
      const slot=slots[idx];
      const info=SHIFTS[sk];
      pills.push(`<div class="msp ${sk}">
        <strong>${day.weekday} ${d.getDate()} ${MONTHS[d.getMonth()]}</strong>
        <span>${info.label}</span>
        ${slot.rooms&&slot.rooms!=='‚Äî'?`<span>üö™ ${slot.rooms}</span>`:''}
      </div>`);
    });
  });
  document.getElementById('my-shifts').innerHTML=pills.length
    ?pills.join('')
    :'<span style="color:var(--text3);font-size:13px">N√£o est√°s escalado(a) esta semana neste servi√ßo.</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEditor(week){
  const body=document.getElementById('ed-body');
  if(!week.days?.length){body.innerHTML='';return;}
  const svc=state.activeSvc;
  const cat=state.activeCat;
  const cfg=SERVICES[svc];
  const hints = cat==='auxiliares' ? cfg.auxRoomsHint : cfg.roomsHint;
  const cm={manha:'var(--manha)',tarde:'var(--tarde)',noite:'var(--noite)'};

  body.innerHTML=(week.days||[]).map((day,di)=>{
    const d=new Date(day.date+'T00:00:00');
    const tm=isToday(day.date)?' üìç':'';
    const shifts=['manha','tarde','noite'].map(sk=>{
      const slots=day[sk]||[];
      if(!slots.length) return '';
      const c=cm[sk];
      const hints_sk=hints[sk]||[];
      const posPrefix=sk==='manha'?'M':sk==='tarde'?'T':'N';
      const g=slots.length===3?'g3':'';
      const postos=svc==='URG'?(cat==='auxiliares'?cfg.auxPostos:cfg.postos):null;

      const nameInputs=slots.map((slot,si)=>`<div class="ef">
        <label>${postos?postos[si]:`${posPrefix}${si+1}`}</label>
        <input type="text" value="${slot.name||''}" placeholder="Nome" oninput="updSlot(${di},'${sk}',${si},'name',this.value)" autocomplete="off" autocorrect="off">
      </div>`).join('');

      const roomInputs=slots.map((slot,si)=>`<div class="ef">
        <label>üö™ ${postos?postos[si]:`${posPrefix}${si+1}`}</label>
        <input type="text" value="${slot.rooms||''}" placeholder="${hints_sk[si]||''}" oninput="updSlot(${di},'${sk}',${si},'rooms',this.value)" autocomplete="off">
      </div>`).join('');

      return `<div class="ed-shift">
        <div class="ed-shift-title" style="color:${c}">
          <span style="width:7px;height:7px;border-radius:50%;background:${c};display:inline-block"></span>
          ${posPrefix} ¬∑ ${slots.length} posi√ß√µes
        </div>
        <div class="pos-group">
          <div class="pos-group-lbl">üë§ Nomes</div>
          <div class="pos-inputs ${g}">${nameInputs}</div>
        </div>
        <div class="pos-group">
          <div class="pos-group-lbl">üö™ Quartos</div>
          <div class="pos-inputs ${g}">${roomInputs}</div>
        </div>
      </div>`;
    }).join('');

    const obsField=`<div class="ef" style="margin-top:8px">
      <label>üìù Observa√ß√µes / Tarefas</label>
      <input type="text" value="${day.obs||''}" placeholder="ex: Contabilizar stock farm√°cia" oninput="updObs(${di},this.value)">
    </div>`;

    return `<div class="ed-day">
      <div class="ed-day-hdr" onclick="toggleEdDay(${di})">
        <h4>${day.weekday}, ${d.getDate()} ${MONTHS[d.getMonth()]}${tm}</h4>
        <span class="chev">‚ñæ</span>
      </div>
      <div class="ed-day-body" id="edb-${di}">${shifts}${obsField}</div>
    </div>`;
  }).join('');
}

function toggleEdDay(i){
  const h=document.querySelectorAll('.ed-day-hdr')[i];
  const b=document.getElementById(`edb-${i}`);
  h.classList.toggle('open'); b.classList.toggle('open');
}

function updSlot(di,sk,si,field,val){
  const week=(state.schedule[state.activeSvc][state.activeCat]||{})[state.currentWeek];
  if(!week||!week.days[di])return;
  if(!week.days[di][sk][si])return;
  week.days[di][sk][si][field]=val;
  markUnsaved();
  renderSchedule(week);
}

function updObs(di,val){
  const week=(state.schedule[state.activeSvc][state.activeCat]||{})[state.currentWeek];
  if(!week||!week.days[di])return;
  week.days[di].obs=val;
  markUnsaved();
}

function markUnsaved(){
  state.unsaved++;
  document.getElementById('unsaved-n').textContent=state.unsaved;
  document.getElementById('save-bar').style.display='flex';
}

function savePlan(){
  state.unsaved=0;
  document.getElementById('save-bar').style.display='none';
  saveToStorage();
  const catLabel=state.activeCat==='auxiliares'?'Auxiliares':'Enfermeiros';
  showToast(`‚úÖ Plano ${state.activeSvc} ¬∑ ${catLabel} guardado!`);
}

function discardChanges(){
  if(!confirm('Descartar altera√ß√µes?'))return;
  state.unsaved=0;
  document.getElementById('save-bar').style.display='none';
  renderAll();
}

function publishPlan(){
  const svc=state.activeSvc;
  const cat=state.activeCat;
  const catLabel=cat==='auxiliares'?'Auxiliares':'Enfermeiros';
  if(!confirm(`Publicar o plano de ${svc} ¬∑ ${catLabel}?`))return;
  state.schedule[svc][cat][state.currentWeek].published=true;
  state.unsaved=0;
  document.getElementById('save-bar').style.display='none';
  const notif={id:Date.now(),ico:'üì¢',title:`Plano ${svc} ¬∑ ${catLabel} publicado`,
    msg:`Plano da semana ${weekLabel(state.currentWeek)} publicado por ${state.user.name}.`,time:'Agora',read:false};
  state.notifications.unshift(notif);
  saveToStorage();
  renderNotifs(); renderAll();
  showToast(`üì¢ Plano ${svc} ¬∑ ${catLabel} publicado!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF DOWNLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function downloadPDF(){
  const svc = state.activeSvc;
  const cat = state.activeCat;
  const catLabel = cat==='auxiliares' ? 'Auxiliares de Sa√∫de' : 'Enfermeiros';
  const week = (state.schedule[svc][cat]||{})[state.currentWeek];
  if(!week?.days?.length){ showToast('‚ùå Sem dados para exportar.'); return; }

  showToast('‚è≥ A gerar PDF‚Ä¶');

  const SHIFT_COLORS = { manha:'#fb923c', tarde:'#34d399', noite:'#818cf8' };
  const SHIFT_BG     = { manha:'#fff7ed', tarde:'#f0fdf4', noite:'#f5f3ff' };
  const SHIFT_LABELS = { manha:'Manh√£', tarde:'Tarde', noite:'Noite' };

  // Build HTML for PDF
  const svcLabel = SERVICES[svc].label;
  const weekLbl  = weekLabel(state.currentWeek);

  let daysHtml = week.days.map(day => {
    const d = new Date(day.date+'T00:00:00');
    const isHoje = day.date === isoDate(new Date());
    const shifts = ['manha','tarde','noite'].map(sk => {
      const slots = (day[sk]||[]).filter(s=>s.name);
      if(!slots.length) return '';
      const cells = slots.map(s=>`
        <td style="padding:5px 8px;border:1px solid #e5e7eb;font-size:11px;vertical-align:top">
          <div style="font-weight:600;color:#111">${s.name}</div>
          ${s.rooms&&s.rooms!=='‚Äî'?`<div style="font-size:9px;color:#6b7280;background:#f3f4f6;padding:1px 4px;border-radius:3px;margin-top:2px;display:inline-block">${s.rooms}</div>`:''}
        </td>`).join('');
      const emptyCount = (sk==='noite'?3:5) - slots.length;
      const emptyCells = Array(emptyCount).fill(`<td style="padding:5px 8px;border:1px solid #e5e7eb;font-size:11px;color:#d1d5db">‚Äî</td>`).join('');
      return `<tr>
        <td style="padding:6px 10px;border:1px solid #e5e7eb;white-space:nowrap;font-size:11px;font-weight:700;background:${SHIFT_BG[sk]};color:${SHIFT_COLORS[sk]};width:90px">${SHIFT_LABELS[sk]}</td>
        ${cells}${emptyCells}
      </tr>`;
    }).join('');

    return `<div style="margin-bottom:14px;break-inside:avoid">
      <div style="background:${isHoje?'#eff6ff':'#f9fafb'};border:1px solid ${isHoje?'#bfdbfe':'#e5e7eb'};border-radius:8px 8px 0 0;padding:8px 12px;display:flex;align-items:center;gap:10px">
        <span style="font-size:22px;font-weight:800;color:${isHoje?'#3b82f6':'#374151'};font-family:monospace">${d.getDate()}</span>
        <span style="font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.05em">${MONTHS[d.getMonth()]}</span>
        <span style="font-size:13px;font-weight:600;color:#374151">${day.weekday}</span>
        ${isHoje?'<span style="font-size:10px;background:#dbeafe;color:#3b82f6;padding:2px 8px;border-radius:10px;margin-left:auto">Hoje</span>':''}
      </div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px;overflow:hidden">
        ${shifts||'<tr><td colspan="6" style="padding:10px;font-size:12px;color:#9ca3af;text-align:center;border:1px solid #e5e7eb">Sem escala</td></tr>'}
      </table>
      ${day.obs?`<div style="margin-top:4px;font-size:11px;color:#d97706;background:#fffbeb;border:1px solid #fde68a;border-radius:4px;padding:5px 10px">üìù ${day.obs}</div>`:''}
    </div>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#fff;color:#111;padding:24px;}
    @media print{body{padding:0;} .no-print{display:none}}
  </style></head><body>
  <div style="margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #e5e7eb">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
      <div style="width:40px;height:40px;background:#3b82f6;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üè•</div>
      <div>
        <div style="font-size:18px;font-weight:800;color:#111">Hospital Fernando Pessoa</div>
        <div style="font-size:11px;color:#6b7280">Planos de Trabalho ¬∑ ${svcLabel}</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div style="font-size:13px;font-weight:700;color:#374151">Semana de ${weekLbl}</div>
        <div style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-top:4px;background:${cat==='auxiliares'?'#fff7ed':'#eff6ff'};color:${cat==='auxiliares'?'#f59e0b':'#3b82f6'};border:1px solid ${cat==='auxiliares'?'#fde68a':'#bfdbfe'}">${catLabel}</div>
      </div>
    </div>
    <div style="font-size:10px;color:#9ca3af">Gerado em ${new Date().toLocaleDateString('pt-PT',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} √†s ${new Date().toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'})} ¬∑ Por ${state.user.name}</div>
  </div>
  ${daysHtml}
  </body></html>`;

  // Open print dialog in new window
  const win = window.open('','_blank','width=900,height=700');
  if(!win){ showToast('‚ùå Bloqueador de popups ativo. Permita popups para este site.'); return; }
  win.document.write(html);
  win.document.close();
  win.onload = ()=>{
    setTimeout(()=>{
      win.print();
      showToast('‚úÖ Di√°logo de impress√£o aberto ‚Äî escolha "Guardar como PDF".');
    }, 400);
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNotifs(){
  const unread=state.notifications.filter(n=>!n.read).length;
  document.getElementById('ndot').style.display=unread>0?'block':'none';
  document.getElementById('notif-list').innerHTML=state.notifications.slice(0,10).map(n=>`
    <div class="ni ${n.read?'':'unread'}" onclick="markRead(${n.id})">
      <div class="ni-ico">${n.ico}</div>
      <div class="ni-body"><strong>${n.title}</strong><p>${n.msg}</p><time>${n.time}</time></div>
    </div>`).join('');
}
function toggleNotif(){document.getElementById('notif-panel').classList.toggle('open');renderNotifs();}
function markRead(id){const n=state.notifications.find(x=>x.id===id);if(n)n.read=true;renderNotifs();saveToStorage();}
function markAllRead(){state.notifications.forEach(n=>n.read=true);renderNotifs();saveToStorage();}
document.addEventListener('click',e=>{
  const p=document.getElementById('notif-panel');
  if(p&&!p.contains(e.target)&&!e.target.closest('.notif-wrap'))p.classList.remove('open');
});

function showToast(msg){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div');
  t.className='toast';
  t.style.cssText='position:fixed;bottom:calc(70px + env(safe-area-inset-bottom,0px));left:12px;right:12px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-size:13px;color:var(--text);box-shadow:0 8px 28px rgba(0,0,0,.6);z-index:500;animation:fadeUp .3s ease;text-align:center;max-width:400px;margin:0 auto';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3500);
}
</script>
</body>
</html>
